<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Natasha — качественное компактное решение для извлечения именованных сущностей из новостных статей на русском языке</title>

    <link rel="stylesheet" href="styles/bootstrap.min.css">
    <link rel="stylesheet" href="styles/highlight.css">
    <link rel="stylesheet" href="styles/style.css">
  </head>
  <body>
    <div class="container">
      <div class="row">
	<div class="col-8">
	  <h1>Natasha — качественное компактное решение для извлечения именованных сущностей из новостных статей на русском языке</h1>
	</div>
      </div>

      <div class="row">
      	<div class="col-6">
      	  <p>
      	    <a href="https://github.com/natasha/natasha">Библиотека Natasha</a> решает базовые задачи обработки естественного русского языка: сегментация на токены и предложения, морфологический и синтаксический анализ, лемматизация, извлечение именованных сущностей. Для новостных статей качество на всех задачах <a href="https://github.com/natasha/natasha#evaluation">сравнимо или превосходит существующие решения</a>. Библиотека поддерживает Python 3.5+ и PyPy3, не требует GPU, зависит только от NumPy.
      	  </p>
      	  <p>
      	    В этой статье разберёмся, как Natasha решает задачу извлечение именованных сущностей.
      	  </p>
      	</div>
      </div>
      
      <div id="demo">
      	<div class="row">
      	  <div class="scroll col-6">
      	    <div id="editor">
      	      <div contenteditable="true" id="text">Бурятия и Забайкальский край переданы из Сибирского федерального округа (СФО) в состав Дальневосточного (ДФО). Соответствующий указ подписал президент Владимир Путин, документ опубликован на официальном интернет-портале правовой информации. Этим же указом глава государства поручил руководителю своей администрации утвердить структуру и штатную численность аппаратов полномочных представителей президента в этих двух округах. После исключения Бурятии и Забайкалья в составе СФО остались десять регионов: Алтай, Алтайский край, Иркутская, Кемеровская, Новосибирская, Омская и Томская области, Красноярский край, Тува и Хакасия. Действующим полпредом президента в этом округе является бывший губернатор Севастополя, экс-заместитель командующего Черноморским флотом России Сергей Меняйло. В составе ДФО отныне 11 субъектов. Помимо Бурятии и Забайкалья, это Камчатский, Приморский и Хабаровский края, Амурская, Еврейская автономная, Магаданская и Сахалинская области, а также Якутия и Чукотка. Дальневосточное полпредство возглавляет Юрий Трутнев, совмещающий эту должность с постом вице-премьера в правительстве России. Федеральные округа были созданы в мае 2000 года в соответствии с указом президента Путина.</div>
      	      <div id="markup"></div>
      	    </div>
      	  </div>
      	  <div class="scroll col-6">
      	    <div id="facts"></div>
      	  </div>
      	</div>

      	<div id="controls" class="row">
      	  <div id="examples" class="col-6">
      	    Примеры:
      	    <a href="#" data-text="Бурятия и Забайкальский край переданы из Сибирского федерального округа (СФО) в состав Дальневосточного (ДФО). Соответствующий указ подписал президент Владимир Путин, документ опубликован на официальном интернет-портале правовой информации. Этим же указом глава государства поручил руководителю своей администрации утвердить структуру и штатную численность аппаратов полномочных представителей президента в этих двух округах. После исключения Бурятии и Забайкалья в составе СФО остались десять регионов: Алтай, Алтайский край, Иркутская, Кемеровская, Новосибирская, Омская и Томская области, Красноярский край, Тува и Хакасия. Действующим полпредом президента в этом округе является бывший губернатор Севастополя, экс-заместитель командующего Черноморским флотом России Сергей Меняйло. В составе ДФО отныне 11 субъектов. Помимо Бурятии и Забайкалья, это Камчатский, Приморский и Хабаровский края, Амурская, Еврейская автономная, Магаданская и Сахалинская области, а также Якутия и Чукотка. Дальневосточное полпредство возглавляет Юрий Трутнев, совмещающий эту должность с постом вице-премьера в правительстве России. Федеральные округа были созданы в мае 2000 года в соответствии с указом президента Путина.">Путин уменьшил Сибирский федеральный округ</a>,

      	    <a href="#" data-text="На спутниковых снимках Google Earth, сделанных в конце ноября и демонстрирующих пригород Каменск-Шахтинского в Ростовской области, заметны «сотни российских танков у границы с Украиной», пишет Defence Blog.  Издание отмечает, что военная техника расположена всего в 18 километрах от российско-украинской границы. Кроме сотен танков, прежде всего Т-64 и Т-62М, на снимках можно рассмотреть, в частности, несколько тысяч военных грузовиков. В декабре президент Украины Петр Порошенко заявил, что десантно-штурмовые подразделения Вооруженных сил Украины будут переброшены на границу с Россией. В конце ноября Порошенко своим указом ввел военное положение в ряде регионов Украины, граничащих с Россией и Приднестровьем — Винницкой, Луганской, Николаевской, Одесской, Сумской, Харьковской, Черниговской, Херсонской, Донецкой и Запорожской областях, а также во внутренних водах Азовско-Керченской акватории.">«Танковая орда» на границе России с Украиной попала на спутниковые снимки</a>,

      	    <a href="#" data-text="Башкан (глава) Гагаузской автономии в составе Молдавии Ирина Влах отказалась пожимать протянутую руку президента Молдавии Игоря Додона. На опубликованное в Facebook видео обратило внимание Deschide. Это произошло 18 октября, во время визита Додона и президента Турции Реджепа Тайипа Эрдогана в столицу Гагаузии Комрат. На мероприятиях по случаю визита Влах прошла мимо сидящего с супругой Додона, проигнорировав протянутую ей руку. Осознав, что башкан Гагаузии не собирается его приветствовать, молдавский лидер перевел взгляд на часы. В тот же день Додон и Эрдоган приняли участие в пресс-конференции в Кишиневе. В ходе брифинга турецкий президент задремал.">Додона оставили с протянутой рукой</a>,

      	    <a href="#" data-text="Специалисты признали македонский Тетово самым грязным европейским городом. Данные приведены на сайте Numbeo в рейтинге Pollution Index 2018 Mid-Year. Список составлен на основе анализа экологии 76 городов Европы. Показатель загрязнения Тетово — 97,57 пункта. Вторую позицию занял итальянский Неаполь (84,61 пункта). На третьем месте — столица Македонии Скопье с индексом 82,17 пункта. Также в топ-10 вошли албанская столица Тирана, итальянский Турин, румынский Бухарест, столица Боснии и Герцеговины Сараево, польский Краков, Пловдив (Болгария), а также столица Украины Киев. Санкт-Петербург занял 17-е место, обогнав Москву по уровню загрязнения на две позиции. Самыми благоприятными для жизни с точки зрения экологии стали две европейские столицы — Хельсинки (Финляндия) и Рейкьявик (Исландия). В марте столица Ирака Багдад была признана худшим в мире городом для проживания по версии международной консалтинговой компании Mercer. Следом за Багдадом в списке из 450 населенных пунктов идет Банги — столица Центральноафриканской Республики (ЦАР).">Назван самый грязный город Европы</a>,

      	    <a href="#" data-text="В Москве на вечеринке «Крыши мира» в «Бессонице» за диджейский пульт встанет канадский музыкант Art Department. Об этом «Ленте.ру» сообщили организаторы. Мероприятие пройдет в пятницу, 16 ноября. Art Department — проект канадского музыканта Джонни Уайта. В прошлом году Уайт выступил на вечеринках Circoloco и Elrow, отыграл в берлинском Watergate и Hï на Ибице, а также был заявлен в качестве одного из хедлайнеров фестиваля BPM в Португалии. Art Department — постоянный участник вечеринок Paradise, знаковых шоукейсов Джейми Джонса. Помимо диджеинга, Уайт ведет свой лейбл No.19 Music, объединивший таких музыкантов, как Мэтью Джонсон, Джейми Джонс, Martinez Brothers и Дэннис Феррер. Заказать билеты можно по ссылке.">На вечеринке в Москве выступит Art Department</a>,

      	    <a href="#" data-text="Президент России Владимир Путин предложил Георгию Полтавченко покинуть пост губернатора Санкт-Петербурга. Об этом в среду, 3 октября, сообщил пресс-секретарь главы государства Дмитрий Песков, его слова приводит ТАСС. По словам Пескова, занять место врио губернатора предложено полномочному представителю президента в Северо-Западном федеральном округе Александру Беглову. «Владимир Путин только что провел встречу с Бегловым и Полтавченко. Путин предложил Полтавченко возглавить ОСК (Объединенную судостроительную корпорацию — прим. «Ленты.ру») в качестве председателя совета директоров компании, а Беглову предложил стать исполняющим обязанности губернатора Санкт-Петербурга до сентября, до выборов», — пояснил представитель Кремля. Как уточнили в пресс-службе Кремля, президент уже подписал соответствующий указ. Полтавченко возглавлял администрацию Петербурга с 2011 года. Беглов был назначен полномочным представителем президента в СЗФО в 2017 году. До этого в течение пяти лет он занимал аналогичную должность в Центральном федеральном округе. Накануне, 2 октября, о сложении полномочий сообщил губернатор Липецкой области Олег Королев, а также глава Курганской области Алексей Кокорин. Исполняющими обязанности глав регионов были назначены Игорь Артамонов и Вадим Шумков соответственно.">Путин убрал Полтавченко с поста губернатора Петербурга</a>,

      	    <a href="#" data-text="Председатель Банка России Эльвира Набиуллина посетила Университет спецназа в Чечне. Видеоотчет о ее визите опубликован в Instagram учебного заведения. Глава Центробанка понаблюдала за занятиями по огневой и тактико-огневой подготовке, побывала на уроках практической стрельбы. Кроме того, Набиуллину прокатили на багги «Чаборз М-3». Руководитель ЦБ приехала в Чечню в субботу, 29 сентября, для участия в заседании межбанковского совета Центробанков России и Белоруссии.">Набиуллину в Чечне покатали на багги</a>,

      	    <a href="#" data-text="Абсолютный бойцовский чемпионат (UFC) объявил, что американец Майкл Джонсон станет соперником россиянина Артема Лобова в бою на турнире UFC Fight Night. Изначально с Лобовым должен был драться его соотечественник Зубайра Тухугов. Поединок состоится 27 октября. «Майкл Джонсон заменит Зубайру Тухугова в бою с Артемом Лобовым из-за расследования, которое проводит Атлетическая комиссия штата Невада», — говорится в сообщении. Тухугов — секундант россиянина Хабиба Нурмагомедова. Глава промоушена Дэйна Уайт после победы Нурмагомедова над Конором Макгрегором пообещал, что бойцы, напавшие на ирландца после боя, будут изгнаны из UFC. Тухугов был одним из тех, кто атаковал Макгрегора. Из-за этих слов между UFC и Нурмагомедовым возник конфликт: россиянин пригрозил разорвать свой контракт, если промоушен откажется от Тухугова. 17 октября Дэйна Уайт сообщил, что Нурмагомедов останется в организации.">UFC официально отстранил напавшего на Макгрегора российского бойца</a>,

      	    <a href="#" data-text="Испания не будет блокировать сделку по выходу Великобритании из Европейского союза из-за вопроса Гибралтара. Об этом сообщил премьер-министр Испании Педро Санчес, передает AFP. «Я только что сообщил королю, что Испания достигла соглашения по Гибралтару. Завтра состоится заседание Европейского Совета. Европа и Соединенное Королевство приняли требования Испании. Испания отменила вето и будет голосовать за Brexit», — сказал Санчес в субботу, 24 ноября. Глава Европейского совета Дональд Туск сказал, что сделка снизит «риски и потери» от выхода Британии из Евросоюза. «Хотя в этот день ни у кого не будет причин для счастья, я хотел бы подчеркнуть одну вещь: в этот критический момент 27 членов ЕС прошли тест на единство и солидарность», — сказал Туск. Ранее Санчес заявлял, что Мадрид может блокировать соглашение о выходе Британии из ЕС, если в нем не будет прописан статус Гибралтара — британской территории на Пиренейском полуострове.">Испания согласилась поддержать Brexit</a>,

      	    <a href="#" data-text="Движение «Талибан» (запрещено в России) выбрало представителей, которые отправятся в Москву на консультации по ситуации в Афганистане. Об этом сообщает телеканал 1TV на своей странице в Twitter. По его данным, в российскую столицу должны прибыть пять человек: Мухаммад Аббас Станикзай, Салам Ханафи, Шахабуддин Делавар, Зия-ур-Рахман Мадани и Мухаммад Сохаил Шахин. Отмечается, что они не собираются проводить никаких официальных переговоров с делегацией из Кабула. Ранее в МИД России сообщили, что заседание состоится 9 ноября в рамках Московского формата консультаций по Афганистану. Участие в нем примут заместители министров иностранных дел и спецпредставители ряда государств. Приглашения были направлены Афганистану, Индии, Ирану, Казахстану, Киргизии, Китаю, Пакистану, Таджикистану, Туркменистану, Узбекистану, а также США. «Талибан» образовался в 1994 году в разгар Афганской войны. В 1996-2001 годах талибы находились у власти в стране, а после свержения в 2001-м начали вести партизанскую войну с правительственными войсками и силами НАТО в Афганистане и Пакистане. В настоящее время движение и афганское правительство ищут способы достичь политического компромисса, однако столкновения между ними продолжаются. В 2003 году Совет Безопасности ООН и Верховный суд России признали «Талибан» террористической организацией.">В Москву пожалуют пять талибов</a>.
      	  </div>

      	  <div class="column col-6">
      	    <div>
      	      <input id="run" type="submit" value="Обработать">
      	      <input id="running" type="submit" value="Обработка" disabled="true">
      	      <span>(Shift+Enter)</span>
      	    </div>
      	  </div>
      	</div>
      </div>

      <div class="row">
      	<div class="col-6">
      	  <p>
      	    Задача извлечения именнованных сущностей (NER) старая и хорошо изученная.
      	  </p>

      	  <p>
      	    Для английского языка с 1997 года проводятся соревнования: <a href="https://www-nlpir.nist.gov/related_projects/muc/proceedings/ne_task.html">MUC-7</a>, <a href="https://www.aclweb.org/anthology/W03-0419/">CoNLL-2003</a>, <a href="https://catalog.ldc.upenn.edu/docs/LDC2013T19/OntoNotes-Release-5.0.pdf">OntoNotes 5</a>.

      	     Существует масса коммерческих и открытых решений: <a href="https://spacy.io/">Spacy</a>, <a href="https://nlp.stanford.edu/software/CRF-NER.shtml">Stanford NER</a>, <a href="https://opennlp.apache.org/">OpenNLP</a>, <a href="http://www.nltk.org/">NLTK</a>, <a href="https://github.com/mit-nlp/MITIE">MITIE</a>, <a href="https://cloud.google.com/natural-language/">Google Natural Language API</a>, <a href="https://www.paralleldots.com/named-entity-recognition">ParallelDots</a>, <a href="https://aylien.com/text-api/">Aylien</a>, <a href="https://www.basistech.com/text-analytics/rosette/entity-extractor/">Rosette</a>, <a href="https://www.textrazor.com/">TextRazor</a>.
      	  </p>

      	  <p>
      	    Для русского тоже есть бенчмарки: <a href="http://www.labinform.ru/pub/named_entities/">Collection 5</a>, <a href="https://github.com/dialogue-evaluation/factRuEval-2016/">factRuEval-2016</a>, <a href="http://bsnlp.cs.helsinki.fi/shared_task.html">BSNLP-2019</a>, <a href="https://www.researchgate.net/publication/262203599_Introducing_Baselines_for_Russian_Named_Entity_Recognition">Gareev</a>, <a href="https://www.aclweb.org/anthology/I17-1042/">WiNER</a>.

      	    Решения в основном закрытые: <a href="https://dadata.ru/">DaData</a>, <a href="http://pullenti.ru/?AspxAutoDetectCookieSupport=1">Pullenti</a>, <a href="https://www.abbyy.com/ru-ru/infoextractor/">Abbyy Infoextractor</a>, <a href="http://dictum.ru/ru/named-entities-extraction/blog">Dictum</a>, <a href="http://eurekaengine.ru/">Eureka</a>, <a href="http://www.promt.ru/press/news/57586/">Promt</a>, <a href="http://www.rco.ru/?page_id=3554">RCO</a>, <a href="http://www.aot.ru/">AOT</a>, <a href="http://www.ixlab.ru/site/onwork">Ahunter</a>.
      	  </p>

      	  <p>
      	    В 2018 году для русского появилось два хороших открытых решения: <a href="https://habr.com/ru/post/349864/">первая версия Natasha</a> и <a href="https://github.com/deepmipt/ner">DeepPavlov NER</a> от проекта iPavlov из МФТИ. У DeepPavlov было высокое качество и неудобный интерфейс. У Natasha наоборот: удобный интерфейс и низкое качество, решение было построено на правилах.
      	  </p>

      	  <p>
      	    В конце 2018 года после <a href="https://arxiv.org/abs/1810.04805">статьи от Google про BERT</a> в англоязычном NLP случился большой прогресс. В 2019 ребята из МФТИ адаптировали BERT для русского, появился <a href="http://docs.deeppavlov.ai/en/master/features/models/bert.html#bert-for-named-entity-recognition-sequence-tagging">DeepPavlov BERT NER</a>. У новой модели великолепное качество, в 2 раза меньше ошибок чем у DeepPavlov NER, но размер и производительность пугают: 6ГБ — потребление GPU RAM, 2ГБ — размер модели, 13 статей в секунду — производительность на хорошей GPU.
      	  </p>

      	  <p>
      	    В 2020 году в новой версии Natasha нам удалось вплотную приблизится по качеству к DeepPavlov BERT NER, размер модели получился в 75 раз меньше (27МБ), потребление памяти в 30 раз меньше (205МБ), производительность в 2 раза больше на CPU (25 статей в секунду).
      	  </p>
      	</div>

      	<div class="col-6">
      	  <table class="table table-borderless">
      	    <thead>
      	      <tr>
      		<th></th>
      		<th scope="col">Natasha (Slovnet NER)</th>
      		<th scope="col">DeepPavlov BERT NER</th>
      	      </tr>
      	    </thead>
      	    <tbody>
      	      <tr>
      		<td>PER/LOC/ORG F1 по токенам, среднее по Collection 5, factRuEval-2016, BSNLP-2019, Gareev</td>
      		<td>0.97/0.91/0.85</td>
      		<td>0.98/0.92/0.86</td>
      	      </tr>

      	      <tr>
      		<td>Размер модели</td>
      		<td>27МБ</td>
      		<td>2ГБ</td>
      	      </tr>

      	      <tr>
      		<td>Потребление памяти</td>
      		<td>205МБ</td>
      		<td>6ГБ (GPU)</td>
      	      </tr>

      	      <tr>
      		<td>Производительность, новостных статей в секунду</td>
      		<td>25 (CPU Core i5)</td>
      		<td>13 (GPU RTX 2080 Ti)</td>
      	      </tr>

      	      <tr>
      		<td>Время инициализации, секунд</td>
      		<td>1</td>
      		<td>35</td>
      	      </tr>

      	      <tr>
      		<td></td>
      		<td>Python 3.5+, PyPy3</td>
      		<td>Python 3.6+</td>
      	      </tr>

      	      <tr>
      		<td></td>
      		<td>NumPy</td>
      		<td>TensorFlow</td>
      	      </tr>
      	    </tbody>
      	  </table>
      	</div>
      </div>

      <div class="row">
	<div class="col-6">
	  <p>
	    Как удалось получить такой результат? Короткий рецепт:
	  </p>

	  <p class="highlight">
	    Natasha (<a href="https://github.com/natasha/slovnet#ner">Slovnet NER</a>) = дообученный на новостях <a href="http://docs.deeppavlov.ai/en/master/features/models/bert.html">DeepPavlov RuBERT</a> + CRF-голова (<a href="https://github.com/natasha/slovnet/blob/master/scripts/02_bert_ner/main.ipynb">Slovnet BERT NER</a>) + дистиляция через разметку <a href="https://github.com/natasha/corus#load_lenta">Lenta.ru</a> в Word CNN CRF c квантованными эмбедингами (<a href="https://github.com/natasha/navec">Navec</a>).
	  </p>
	</div>
      </div>

      <div class="row">
	<div class="col-6">
	  <p>
	    Теперь подробнее. Попробуем немного улучшим модель DeepPavlov BERT NER. Качество NER измеряют на новостных текстах. Дообучим RuBERT от DeepPavlov на 12ГБ статей из Интефакса, Ленты, Фонтанки. RuBERT использует огромный словарь на 120&nbsp;000 сабтокенов — наследие мультиязычного BERT от Google. Сократим размер до 50&nbsp;000 самых частотых для новостей, покрытие уменьшится на 5%. Используем техники из <a href="https://arxiv.org/abs/1907.11692">статьи про RoBERTa</a>: большие агрегированные батчи, динамическая маска, отказ от предсказания следующего предложения (NSP). Получим <a href="https://github.com/natasha/slovnet/blob/master/scripts/01_bert_news/main.ipynb">NewsRuBERT</a>, который предсказывает замаскированные сабтокены в новостях на 5% лучше чем RuBERT.
	  </p>

	  <p>
	    Обучим CRF-голову на <a href="https://github.com/natasha/corus#load_ne5">Collection 5</a>. Получим <a href="https://github.com/natasha/slovnet/blob/master/scripts/02_bert_ner/main.ipynb">Slovnet BERT NER</a>, качество незначительно лучше, чем DeepPavlov BERT NER (+0.5%), размер модели меньше в 4 раза (473МБ), работает в 3 раза быстрее (40 статей в секунду).
	  </p>
	</div>

	<div class="note col-6">
	  <ul>
	    <li>
<a href="https://github.com/natasha/corus">Corus</a> — репозиторий со ссылками на новостные корпуса. Есть малоизвестные, например, <a href="https://github.com/natasha/corus#load_ods_interfax">Интерфакс</a> (1.2ГБ), <a href="https://github.com/natasha/corus#load_ods_gazeta">Газета.ру</a> (1.6Гб) от энтузиастов из ODS;
	    </li>
	    <li>
	      С PyTorch 1.4 <a href="https://github.com/natasha/slovnet/blob/c4f961c23ba0eebb216cae3dc79817e8e6600a6f/slovnet/model/bert.py#L46-L106">реализация NewsRuBERT</a> занимает 100 строк.
	    </li>
	    <li>
	      <a href="https://github.com/natasha/slovnet#ner-1">Сравнение качества и производительности</a> DeepPavlov BERT NER, Slovnet BERT NER и других решений задачи NER для русского языка.
	    </li>
	  </ul>
	</div>
      </div>

      <div class="row">
	<div class="col-6">
	  <p>
	    Размер BERT-моделей пугает. NER — простая задача. 
	  </p>
	</div>
      </div>


    </div>

    <script src="scripts/jquery-3.5.1.min.js" type="text/javascript"></script>
    <script src="scripts/popper.min.js" type="text/javascript"></script>
    <script src="scripts/bootstrap.min.js" type="text/javascript"></script>
    <script src="scripts/highlight.pack.js" type="text/javascript"></script>
    <script src="scripts/demo.js" type="text/javascript"></script>
  </body>
</html>
